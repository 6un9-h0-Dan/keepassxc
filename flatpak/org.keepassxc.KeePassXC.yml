---
id: org.keepassxc.KeePassXC
runtime: org.kde.Platform
runtime-version: "5.15"
sdk: org.kde.Sdk
command: keepassxc
cleanup:
  - "*.a"
  - "*.h"
  - "*.la"
  - /include
  - /lib/pkgconfig
finish-args:
  - "--share=ipc"
  - "--socket=x11"
  - "--socket=wayland"
  - "--talk-name=org.freedesktop.Notifications"
  - "--talk-name=org.freedesktop.ScreenSaver"
  - "--talk-name=org.freedesktop.login1.Manager"
  - "--talk-name=org.freedesktop.login1.Session"
  - "--talk-name=org.gnome.ScreenSaver"
  - "--talk-name=org.gnome.SessionManager"
  - "--talk-name=org.gnome.SessionManager.Presence"
  - "--talk-name=com.canonical.Unity.Session"
  - "--talk-name=org.kde.StatusNotifierWatcher"
  - "--own-name=org.kde.StatusNotifierItem-2-1"
  - "--own-name=org.kde.StatusNotifierItem-2-2"
  - "--own-name=org.kde.StatusNotifierItem-3-2"
  - "--share=network"
  - "--device=all"
  - "--filesystem=/tmp"
  - "--socket=ssh-auth"
  - "--filesystem=host"
  - "--filesystem=xdg-run/gvfs"
  - "--talk-name=org.gtk.vfs"
  - "--talk-name=org.gtk.vfs.*"
modules:
  - modules/libusb.yml
  - name: minizip
    subdir: contrib/minizip
    sources:
      - type: archive
        url: https://zlib.net/zlib-1.2.12.tar.gz
        sha256: 91844808532e5ce316b3c010929493c0244f3d37593afd6de04f71821d5136d9
      - type: script
        dest: contrib/minizip/
        dest-filename: autogen.sh
        commands:
          - autoreconf -ifv
  - name: libargon2
    sources:
      - type: archive
        url: "https://github.com/P-H-C/phc-winner-argon2/archive/20190702.tar.gz"
        sha256: daf972a89577f8772602bf2eb38b6a3dd3d922bf5724d45e7f9589b5e830442c
        x-checker-data:
          type: anitya
    buildsystem: simple
    build-commands:
      - "PREFIX=${FLATPAK_DEST} LIBRARY_REL=lib make -j$FLATPAK_BUILDER_N_JOBS"
      - "PREFIX=${FLATPAK_DEST} LIBRARY_REL=lib make install"
    post-install:
      - "install -Dm644 LICENSE ${FLATPAK_DEST}/share/licenses/libargon2/LICENSE"
  - name: libqrencode
    sources:
      - type: archive
        url: "https://fukuchi.org/works/qrencode/qrencode-4.1.1.tar.gz"
        sha512: 209bb656ae3f391b03c7b3ceb03e34f7320b0105babf48b619e7a299528b8828449e0e7696f0b5db0d99170a81709d0518e34835229a748701e7df784e58a9ce
    config-opts:
      - "-DWITH_TOOLS=NO"
      - "-DBUILD_SHARED_LIBS=YES"
    buildsystem: cmake-ninja
    post-install:
      - install -Dm644 -t /app/share/licenses/libqrencode COPYING
    cleanup:
      - /share/man
  - name: botan
    buildsystem: simple
    build-commands:
      - "python3 ./configure.py \
          --disable-cc-tests \
          --disable-static-library \
          --prefix=/app \
          --with-openssl \
          --with-zlib \
          --without-documentation"
      - make -j${FLATPAK_BUILDER_N_JOBS}
      - make install
    sources:
      - type: git
        url: https://github.com/randombit/botan.git
        tag: 2.14.0
        commit: 3a26a33de2459c40cdfb766f4035a60cf449ab1c
  - name: pcsclite
    config-opts:
      - --sbindir=/app/bin
    sources:
      - type: archive
        url: https://github.com/LudovicRousseau/PCSC/archive/1.9.5/PCSC-1.9.5.tar.gz
        sha256: 4c8cd8fa86004fd3c2fe252f2505d607f1752133d2ff1841f7e8b54fb94b4f73
    cleanup:
      - /bin
  - name: keepassxc
    sources:
      - type: git
        path: "./"
    config-opts:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DKEEPASSXC_DIST_TYPE=Flatpak"
      - "-DKEEPASSXC_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_LIBDIR=lib"
      - "-DWITH_XC_UPDATECHECK=OFF"
      - "-DWITH_XC_AUTOTYPE=ON"
      - "-DWITH_XC_NETWORKING=ON"
      - "-DWITH_XC_BROWSER=ON"
      - "-DWITH_XC_YUBIKEY=ON"
      - "-DWITH_XC_SSHAGENT=ON"
      - "-DWITH_XC_KEESHARE=ON"
      - "-DWITH_XC_FDOSECRETS=OFF"
      - "-DWITH_XC_DOCS=OFF"
    buildsystem: cmake
    post-install:
      - |
        for f in COPYING LICENSE*; do
          install -Dm644 $f /app/share/licenses/org.keepassxc.KeePassXC/$f
        done
    cleanup:
      - /share/man
